{"version":3,"sources":["../../../src/collections/Users/index.ts"],"sourcesContent":["import type { AccessArgs, CollectionConfig, PayloadRequest, User } from 'payload'\n\nimport { createAuthClient } from 'better-auth/react'\nimport { APIError } from 'payload'\n\nimport { type CryptoSignature, verifyCanonical } from '../../better-auth/crypto-shared.js'\n\nconst INTERNAL_SECRET = process.env.BA_TO_PAYLOAD_SECRET!\n\ntype isAuthenticated = (args: AccessArgs<User>) => boolean\nconst authenticated: isAuthenticated = ({ req: { user } }) => {\n  return Boolean(user)\n}\n\n// (optional) simple anti-replay for Local API calls\nconst seenNonces = new Map<string, number>()\nconst TTL = 5 * 60 * 1000\nsetInterval(() => {\n  const now = Date.now()\n  for (const [k, exp] of seenNonces) {\n    if (exp < now) {\n      seenNonces.delete(k)\n    }\n  }\n}, 60_000).unref()\n\nfunction basicSigOk(req: { context: { baSig?: CryptoSignature } } & PayloadRequest) {\n  const sig = req.context.baSig\n  const body = req.context.baBody\n  if (!sig || !body) {\n    return false\n  }\n  const ok = verifyCanonical(body, sig, INTERNAL_SECRET)\n  if (!ok) {\n    return false\n  }\n  if (seenNonces.has(sig.nonce)) {\n    return false\n  } // replay\n  // don't mark used yet; final verification happens in hooks\n  return true\n}\n\nexport function createUsersCollection({\n  authClientOptions,\n}: {\n  authClientOptions: Parameters<typeof createAuthClient>['0']\n}): CollectionConfig {\n  const authClient = createAuthClient(authClientOptions)\n  return {\n    slug: 'users',\n    access: {\n      admin: authenticated,\n      // Disable manual user management through Payload admin\n      // Users can only be managed through better-auth\n      create: ({ req }) => basicSigOk(req),\n      delete: ({ req }) => basicSigOk(req),\n      read: authenticated,\n      update: ({ req }) => basicSigOk(req),\n    },\n    admin: {\n      defaultColumns: ['name', 'email'],\n      useAsTitle: 'name',\n    },\n    auth: {\n      disableLocalStrategy: true,\n      strategies: [\n        {\n          name: 'better-auth',\n          authenticate: async ({ headers, payload }) => {\n            // Validate Better Auth session (cookie/JWT) from headers\n            const session = await authClient.getSession({ fetchOptions: { headers } })\n            if (!session.data) {\n              return { user: null }\n            }\n            const externalId = session.data.user.id\n\n            // Find or provision the minimal Payload user\n            const existing = await payload.find({\n              collection: 'users',\n              limit: 1,\n              where: { externalId: { equals: externalId } },\n            })\n            const doc =\n              existing.docs[0] ??\n              (await payload.create({\n                collection: 'users',\n                data: { externalId },\n              }))\n\n            return { user: { collection: 'users', ...doc } }\n          },\n        },\n      ],\n    },\n    fields: [\n      { name: 'externalId', type: 'text', index: true, required: true, unique: true },\n      {\n        name: 'name',\n        type: 'text',\n      },\n    ],\n    hooks: {\n      beforeChange: [\n        async ({ data, operation, originalDoc, req }) => {\n          if (operation === 'create') {\n            // authoritative check: tie signature to the actual mutation\n            const sig = req.context.baSig as CryptoSignature | undefined\n            const expectedBody = { op: 'create', userId: data.externalId }\n            if (!sig || !verifyCanonical(expectedBody, sig, INTERNAL_SECRET)) {\n              return Promise.reject(new APIError('User creation is managed by Better Auth.'))\n            }\n            // mark nonce as used\n            seenNonces.set(sig.nonce, Date.now() + TTL)\n          } else if (operation === 'update') {\n            // authoritative check: tie signature to the actual mutation\n            const sig = req.context.baSig as CryptoSignature | undefined\n            const userId = originalDoc?.externalId || data.externalId\n            const expectedBody = { op: 'update', userId }\n            if (!sig || !verifyCanonical(expectedBody, sig, INTERNAL_SECRET)) {\n              return Promise.reject(new APIError('User updates are managed by Better Auth.'))\n            }\n            // mark nonce as used\n            seenNonces.set(sig.nonce, Date.now() + TTL)\n          }\n          return data\n        },\n      ],\n      beforeDelete: [\n        async ({ id, req }) => {\n          // Get the document first to access externalId\n          const doc = await req.payload.findByID({\n            id,\n            collection: 'users',\n          })\n\n          const sig = req.context.baSig as CryptoSignature | undefined\n          const expectedBody = { op: 'delete', userId: doc.externalId }\n          if (!sig || !verifyCanonical(expectedBody, sig, INTERNAL_SECRET)) {\n            return Promise.reject(new APIError('User deletion is managed by Better Auth.'))\n          }\n          seenNonces.set(sig.nonce, Date.now() + TTL)\n        },\n      ],\n    },\n    timestamps: true,\n  }\n}\n"],"names":["createAuthClient","APIError","verifyCanonical","INTERNAL_SECRET","process","env","BA_TO_PAYLOAD_SECRET","authenticated","req","user","Boolean","seenNonces","Map","TTL","setInterval","now","Date","k","exp","delete","unref","basicSigOk","sig","context","baSig","body","baBody","ok","has","nonce","createUsersCollection","authClientOptions","authClient","slug","access","admin","create","read","update","defaultColumns","useAsTitle","auth","disableLocalStrategy","strategies","name","authenticate","headers","payload","session","getSession","fetchOptions","data","externalId","id","existing","find","collection","limit","where","equals","doc","docs","fields","type","index","required","unique","hooks","beforeChange","operation","originalDoc","expectedBody","op","userId","Promise","reject","set","beforeDelete","findByID","timestamps"],"mappings":"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"}