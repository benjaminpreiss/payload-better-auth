{"version":3,"sources":["../../src/storage/SqliteStorage.ts"],"sourcesContent":["import type { SecondaryStorage } from './types'\n\n/**\n * Minimal SQLite database interface.\n * Compatible with Node.js 22+ native `node:sqlite` DatabaseSync.\n */\nexport interface SqliteDatabase {\n  exec(sql: string): void\n  prepare(sql: string): SqliteStatement\n}\n\nexport interface SqliteStatement {\n  get(...params: unknown[]): unknown\n  run(...params: unknown[]): { changes: bigint | number }\n}\n\n/**\n * Helper to run a database operation with retry logic for \"database is locked\" errors.\n */\nfunction withRetry<T>(operation: () => T, maxRetries = 3): T {\n  let retries = maxRetries\n  while (retries > 0) {\n    try {\n      return operation()\n    } catch (error) {\n      if (\n        retries > 1 &&\n        error instanceof Error &&\n        (error.message.includes('database is locked') || error.message.includes('SQLITE_BUSY'))\n      ) {\n        retries--\n        // Small delay before retry using exponential backoff\n        const delay = (maxRetries - retries + 1) * 50 // 50ms, 100ms, 150ms\n        Atomics.wait(new Int32Array(new SharedArrayBuffer(4)), 0, 0, delay)\n      } else {\n        throw error\n      }\n    }\n  }\n  // This shouldn't be reached, but TypeScript needs it\n  throw new Error('Retry exhausted')\n}\n\n/**\n * Global key for cleanup interval to survive HMR.\n */\nconst CLEANUP_KEY = '__payloadBetterAuthSqliteCleanup__'\n\ninterface CleanupState {\n  interval: null | ReturnType<typeof setInterval>\n}\n\nfunction getCleanupState(): CleanupState {\n  const g = globalThis as unknown as { [CLEANUP_KEY]?: CleanupState }\n  if (!g[CLEANUP_KEY]) {\n    g[CLEANUP_KEY] = { interval: null }\n  }\n  return g[CLEANUP_KEY]\n}\n\nexport interface SqliteStorageOptions {\n  /**\n   * SQLite database instance from Node.js 22+ native `node:sqlite`.\n   *\n   * @example\n   * import { DatabaseSync } from 'node:sqlite'\n   * const db = new DatabaseSync('.dev-sync-state.db')\n   */\n  db: SqliteDatabase\n}\n\n/**\n * Create a SQLite-backed storage adapter using Node.js 22+ native sqlite.\n *\n * **Note:** This adapter is intended for development and testing only.\n * For staging and production environments, use `createRedisStorage` instead.\n *\n * Suitable for:\n * - Local development (persists across HMR and restarts)\n * - Testing environments\n * - No native bindings to manage - built into Node.js\n *\n * Data is stored on disk and survives process restarts.\n *\n * @example\n * import { DatabaseSync } from 'node:sqlite'\n * import { createSqliteStorage } from 'payload-better-auth/storage'\n *\n * const db = new DatabaseSync('.dev-sync-state.db')\n * const storage = createSqliteStorage({ db })\n */\nexport function createSqliteStorage(options: SqliteStorageOptions): SecondaryStorage {\n  const nodeEnv = process.env.NODE_ENV?.toLowerCase()\n  if (nodeEnv === 'staging' || nodeEnv === 'production') {\n    // eslint-disable-next-line no-console\n    console.warn(\n      `\\n⚠️  [payload-better-auth] WARNING: SqliteStorage is not recommended for ${nodeEnv} environments.\\n` +\n        '   Use createRedisStorage() for distributed/multi-server deployments.\\n',\n    )\n  }\n\n  const { db } = options\n  const cleanupState = getCleanupState()\n\n  // Enable WAL mode for better concurrent access from multiple processes\n  // This allows concurrent reads and writes from different processes\n  try {\n    db.exec('PRAGMA journal_mode=WAL')\n    db.exec('PRAGMA busy_timeout=5000') // Wait up to 5s if database is locked\n    db.exec('PRAGMA synchronous=NORMAL') // Slightly faster while still safe with WAL\n  } catch {\n    // Ignore PRAGMA errors (might fail in read-only mode)\n  }\n\n  // Create table if not exists\n  withRetry(() => {\n    db.exec(`\n      CREATE TABLE IF NOT EXISTS kv (\n        key TEXT PRIMARY KEY,\n        value TEXT NOT NULL,\n        expires_at INTEGER\n      )\n    `)\n  })\n\n  // Prepare statements for better performance\n  const getStmt = db.prepare('SELECT value, expires_at FROM kv WHERE key = ?')\n  const setStmt = db.prepare('INSERT OR REPLACE INTO kv (key, value, expires_at) VALUES (?, ?, ?)')\n  const deleteStmt = db.prepare('DELETE FROM kv WHERE key = ?')\n  const cleanupStmt = db.prepare('DELETE FROM kv WHERE expires_at IS NOT NULL AND expires_at < ?')\n\n  // Start cleanup interval if not already running\n  if (!cleanupState.interval) {\n    cleanupState.interval = setInterval(() => {\n      try {\n        withRetry(() => cleanupStmt.run(Date.now()))\n      } catch {\n        // Silently ignore cleanup errors - will retry on next interval\n      }\n    }, 60_000)\n\n    // Don't prevent Node.js from exiting\n    if (typeof cleanupState.interval.unref === 'function') {\n      cleanupState.interval.unref()\n    }\n  }\n\n  return {\n    delete(key: string): Promise<void> {\n      withRetry(() => deleteStmt.run(key))\n      return Promise.resolve()\n    },\n\n    get(key: string): Promise<null | string> {\n      const row = withRetry(\n        () => getStmt.get(key) as { expires_at: null | number; value: string } | undefined,\n      )\n\n      if (!row) {\n        return Promise.resolve(null)\n      }\n\n      // Check expiration\n      if (row.expires_at !== null && row.expires_at < Date.now()) {\n        withRetry(() => deleteStmt.run(key))\n        return Promise.resolve(null)\n      }\n\n      return Promise.resolve(row.value)\n    },\n\n    set(key: string, value: string, ttl?: number): Promise<void> {\n      const expiresAt = ttl ? Date.now() + ttl * 1000 : null\n      withRetry(() => setStmt.run(key, value, expiresAt))\n      return Promise.resolve()\n    },\n  }\n}\n"],"names":["withRetry","operation","maxRetries","retries","error","Error","message","includes","delay","Atomics","wait","Int32Array","SharedArrayBuffer","CLEANUP_KEY","getCleanupState","g","globalThis","interval","createSqliteStorage","options","nodeEnv","process","env","NODE_ENV","toLowerCase","console","warn","db","cleanupState","exec","getStmt","prepare","setStmt","deleteStmt","cleanupStmt","setInterval","run","Date","now","unref","delete","key","Promise","resolve","get","row","expires_at","value","set","ttl","expiresAt"],"mappings":"AAgBA;;CAEC,GACD,SAASA,UAAaC,SAAkB,EAAEC,aAAa,CAAC;IACtD,IAAIC,UAAUD;IACd,MAAOC,UAAU,EAAG;QAClB,IAAI;YACF,OAAOF;QACT,EAAE,OAAOG,OAAO;YACd,IACED,UAAU,KACVC,iBAAiBC,SAChBD,CAAAA,MAAME,OAAO,CAACC,QAAQ,CAAC,yBAAyBH,MAAME,OAAO,CAACC,QAAQ,CAAC,cAAa,GACrF;gBACAJ;gBACA,qDAAqD;gBACrD,MAAMK,QAAQ,AAACN,CAAAA,aAAaC,UAAU,CAAA,IAAK,GAAG,qBAAqB;;gBACnEM,QAAQC,IAAI,CAAC,IAAIC,WAAW,IAAIC,kBAAkB,KAAK,GAAG,GAAGJ;YAC/D,OAAO;gBACL,MAAMJ;YACR;QACF;IACF;IACA,qDAAqD;IACrD,MAAM,IAAIC,MAAM;AAClB;AAEA;;CAEC,GACD,MAAMQ,cAAc;AAMpB,SAASC;IACP,MAAMC,IAAIC;IACV,IAAI,CAACD,CAAC,CAACF,YAAY,EAAE;QACnBE,CAAC,CAACF,YAAY,GAAG;YAAEI,UAAU;QAAK;IACpC;IACA,OAAOF,CAAC,CAACF,YAAY;AACvB;AAaA;;;;;;;;;;;;;;;;;;;CAmBC,GACD,OAAO,SAASK,oBAAoBC,OAA6B;IAC/D,MAAMC,UAAUC,QAAQC,GAAG,CAACC,QAAQ,EAAEC;IACtC,IAAIJ,YAAY,aAAaA,YAAY,cAAc;QACrD,sCAAsC;QACtCK,QAAQC,IAAI,CACV,CAAC,0EAA0E,EAAEN,QAAQ,gBAAgB,CAAC,GACpG;IAEN;IAEA,MAAM,EAAEO,EAAE,EAAE,GAAGR;IACf,MAAMS,eAAed;IAErB,uEAAuE;IACvE,mEAAmE;IACnE,IAAI;QACFa,GAAGE,IAAI,CAAC;QACRF,GAAGE,IAAI,CAAC,6BAA4B,sCAAsC;QAC1EF,GAAGE,IAAI,CAAC,8BAA6B,4CAA4C;IACnF,EAAE,OAAM;IACN,sDAAsD;IACxD;IAEA,6BAA6B;IAC7B7B,UAAU;QACR2B,GAAGE,IAAI,CAAC,CAAC;;;;;;IAMT,CAAC;IACH;IAEA,4CAA4C;IAC5C,MAAMC,UAAUH,GAAGI,OAAO,CAAC;IAC3B,MAAMC,UAAUL,GAAGI,OAAO,CAAC;IAC3B,MAAME,aAAaN,GAAGI,OAAO,CAAC;IAC9B,MAAMG,cAAcP,GAAGI,OAAO,CAAC;IAE/B,gDAAgD;IAChD,IAAI,CAACH,aAAaX,QAAQ,EAAE;QAC1BW,aAAaX,QAAQ,GAAGkB,YAAY;YAClC,IAAI;gBACFnC,UAAU,IAAMkC,YAAYE,GAAG,CAACC,KAAKC,GAAG;YAC1C,EAAE,OAAM;YACN,+DAA+D;YACjE;QACF,GAAG;QAEH,qCAAqC;QACrC,IAAI,OAAOV,aAAaX,QAAQ,CAACsB,KAAK,KAAK,YAAY;YACrDX,aAAaX,QAAQ,CAACsB,KAAK;QAC7B;IACF;IAEA,OAAO;QACLC,QAAOC,GAAW;YAChBzC,UAAU,IAAMiC,WAAWG,GAAG,CAACK;YAC/B,OAAOC,QAAQC,OAAO;QACxB;QAEAC,KAAIH,GAAW;YACb,MAAMI,MAAM7C,UACV,IAAM8B,QAAQc,GAAG,CAACH;YAGpB,IAAI,CAACI,KAAK;gBACR,OAAOH,QAAQC,OAAO,CAAC;YACzB;YAEA,mBAAmB;YACnB,IAAIE,IAAIC,UAAU,KAAK,QAAQD,IAAIC,UAAU,GAAGT,KAAKC,GAAG,IAAI;gBAC1DtC,UAAU,IAAMiC,WAAWG,GAAG,CAACK;gBAC/B,OAAOC,QAAQC,OAAO,CAAC;YACzB;YAEA,OAAOD,QAAQC,OAAO,CAACE,IAAIE,KAAK;QAClC;QAEAC,KAAIP,GAAW,EAAEM,KAAa,EAAEE,GAAY;YAC1C,MAAMC,YAAYD,MAAMZ,KAAKC,GAAG,KAAKW,MAAM,OAAO;YAClDjD,UAAU,IAAMgC,QAAQI,GAAG,CAACK,KAAKM,OAAOG;YACxC,OAAOR,QAAQC,OAAO;QACxB;IACF;AACF"}