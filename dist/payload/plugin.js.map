{"version":3,"sources":["../../src/payload/plugin.ts"],"sourcesContent":["import type { ClientOptions } from 'better-auth'\nimport type { Config } from 'payload'\n\nimport type { EventBus } from '../eventBus/types'\nimport type { SecondaryStorage } from '../storage/types'\n\nimport { createUsersCollection } from '../collections/Users/index'\nimport { createDeduplicatedLogger } from '../shared/deduplicatedLogger'\n\n// Key prefixes for storage\nconst TIMESTAMP_PREFIX = 'timestamp:'\n\nexport type BetterAuthClientOptions = {\n  /**\n   * The external base URL for better-auth, used for client-side requests (from the browser).\n   * This should be the publicly accessible URL.\n   * @example 'https://auth.example.com'\n   */\n  externalBaseURL: string\n  /**\n   * The internal base URL for better-auth, used for server-side requests.\n   * This is used when the server needs to reach better-auth internally (e.g., within a container network).\n   * @example 'http://auth-service:3000'\n   */\n  internalBaseURL: string\n} & Omit<ClientOptions, 'baseURL'>\n\nexport type BetterAuthPayloadPluginOptions = {\n  betterAuthClientOptions: BetterAuthClientOptions\n  /**\n   * Enable debug logging for troubleshooting connection issues.\n   * When enabled, detailed error information will be logged during auth method fetching.\n   */\n  debug?: boolean\n  disabled?: boolean\n  /**\n   * EventBus for timestamp-based coordination between plugins.\n   * Both plugins MUST share the same eventBus instance.\n   *\n   * Available implementations:\n   * - `createSqlitePollingEventBus()` - Uses SQLite for cross-process coordination\n   *\n   * @example\n   * // Create shared eventBus (e.g., in a separate file)\n   * import { createSqlitePollingEventBus } from 'payload-better-auth'\n   * import { DatabaseSync } from 'node:sqlite'\n   * const db = new DatabaseSync('.event-bus.db')\n   * export const eventBus = createSqlitePollingEventBus({ db })\n   */\n  eventBus: EventBus\n  /**\n   * Secondary storage for state coordination between Better Auth and Payload.\n   * Both plugins MUST share the same storage instance.\n   *\n   * Available storage adapters:\n   * - `createSqliteStorage()` - Uses Node.js 22+ native SQLite (no external dependencies)\n   * - `createRedisStorage(redis)` - Redis-backed, for distributed/multi-server production\n   *\n   * @example\n   * // Development (Node.js 22+)\n   * import { createSqliteStorage } from 'payload-better-auth'\n   * import { DatabaseSync } from 'node:sqlite'\n   * const db = new DatabaseSync('.sync-state.db')\n   * const storage = createSqliteStorage({ db })\n   *\n   * @example\n   * // Production (distributed)\n   * import { createRedisStorage } from 'payload-better-auth'\n   * import Redis from 'ioredis'\n   * const storage = createRedisStorage({ redis: new Redis() })\n   */\n  storage: SecondaryStorage\n}\n\nexport const betterAuthPayloadPlugin =\n  (pluginOptions: BetterAuthPayloadPluginOptions) =>\n  (config: Config): Config => {\n    const { externalBaseURL, internalBaseURL, ...restClientOptions } =\n      pluginOptions.betterAuthClientOptions\n    const debug = pluginOptions.debug ?? false\n    const { eventBus, storage } = pluginOptions\n\n    // Create deduplicated logger\n    const logger = createDeduplicatedLogger({\n      enabled: debug,\n      prefix: '[payload]',\n      storage,\n    })\n\n    // Build internal and external auth client options\n    const internalAuthClientOptions = { ...restClientOptions, baseURL: internalBaseURL }\n    const externalAuthClientOptions = { ...restClientOptions, baseURL: externalBaseURL }\n\n    // Log plugin configuration at startup (deduplicated)\n    void logger.log('init', `Initialized (baseURL: ${internalBaseURL})`)\n\n    const Users = createUsersCollection({ storage })\n    if (!config.collections) {\n      config.collections = [Users]\n    } else if (config.collections.find((col) => col.slug === 'users')) {\n      throw new Error('Payload-better-auth plugin: Users collection already present')\n    } else {\n      config.collections.push(Users)\n    }\n\n    /**\n     * If the plugin is disabled, we still want to keep added collections/fields so the database schema is consistent which is important for migrations.\n     * If your plugin heavily modifies the database schema, you may want to remove this property.\n     */\n    if (pluginOptions.disabled) {\n      return config\n    }\n\n    if (!config.endpoints) {\n      config.endpoints = []\n    }\n\n    if (!config.admin) {\n      config.admin = {}\n    }\n\n    if (!config.admin.user) {\n      config.admin.user = Users.slug\n    } else if (config.admin.user !== Users.slug) {\n      throw new Error(\n        'Payload-better-auth plugin: admin.user property already set with conflicting value.',\n      )\n    }\n\n    if (!config.admin.components) {\n      config.admin.components = {}\n    }\n\n    if (!config.admin.components.views) {\n      config.admin.components.views = {}\n    }\n\n    if (!config.admin.components.views.login) {\n      config.admin.components.views.login = {\n        Component: {\n          path: 'payload-better-auth/rsc#BetterAuthLoginServer',\n          serverProps: {\n            debug,\n            externalAuthClientOptions,\n            internalAuthClientOptions,\n          },\n        },\n        exact: true,\n        path: '/auth',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.login property in config already set.',\n      )\n    }\n\n    if (!config.admin.components.views.verifyEmail) {\n      config.admin.components.views.verifyEmail = {\n        Component: 'payload-better-auth/client#VerifyEmailInfoViewClient', // RSC or 'use client' component\n        exact: true,\n        path: '/auth/verify-email',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.verifyEmail property in config already set.',\n      )\n    }\n\n    if (!config.admin.routes) {\n      config.admin.routes = {}\n    }\n\n    if (!config.admin.routes.login) {\n      config.admin.routes.login = '/auth'\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.routes.login property in config already set.',\n      )\n    }\n\n    const incomingOnInit = config.onInit\n\n    config.onInit = async (payload) => {\n      // Ensure we are executing any existing onInit functions before running our own.\n      if (incomingOnInit) {\n        await incomingOnInit(payload)\n      }\n\n      // Set Payload timestamp in storage - Better Auth will see this and trigger reconciliation\n      const timestamp = Date.now()\n      await storage.set(TIMESTAMP_PREFIX + 'payload', String(timestamp))\n      // Also notify via event bus for same-process subscribers\n      eventBus.notifyTimestampChange('payload', timestamp)\n      await logger.log('ready', 'Ready, waiting for Better Auth to sync')\n\n      // Note: User sync is now handled entirely by the reconcile queue on the Better Auth side.\n      // The queue enqueues ensure/delete tasks when users change, and processes them with retries.\n    }\n\n    return config\n  }\n"],"names":["createUsersCollection","createDeduplicatedLogger","TIMESTAMP_PREFIX","betterAuthPayloadPlugin","pluginOptions","config","externalBaseURL","internalBaseURL","restClientOptions","betterAuthClientOptions","debug","eventBus","storage","logger","enabled","prefix","internalAuthClientOptions","baseURL","externalAuthClientOptions","log","Users","collections","find","col","slug","Error","push","disabled","endpoints","admin","user","components","views","login","Component","path","serverProps","exact","verifyEmail","routes","incomingOnInit","onInit","payload","timestamp","Date","now","set","String","notifyTimestampChange"],"mappings":"AAMA,SAASA,qBAAqB,QAAQ,6BAA4B;AAClE,SAASC,wBAAwB,QAAQ,+BAA8B;AAEvE,2BAA2B;AAC3B,MAAMC,mBAAmB;AAgEzB,OAAO,MAAMC,0BACX,CAACC,gBACD,CAACC;QACC,MAAM,EAAEC,eAAe,EAAEC,eAAe,EAAE,GAAGC,mBAAmB,GAC9DJ,cAAcK,uBAAuB;QACvC,MAAMC,QAAQN,cAAcM,KAAK,IAAI;QACrC,MAAM,EAAEC,QAAQ,EAAEC,OAAO,EAAE,GAAGR;QAE9B,6BAA6B;QAC7B,MAAMS,SAASZ,yBAAyB;YACtCa,SAASJ;YACTK,QAAQ;YACRH;QACF;QAEA,kDAAkD;QAClD,MAAMI,4BAA4B;YAAE,GAAGR,iBAAiB;YAAES,SAASV;QAAgB;QACnF,MAAMW,4BAA4B;YAAE,GAAGV,iBAAiB;YAAES,SAASX;QAAgB;QAEnF,qDAAqD;QACrD,KAAKO,OAAOM,GAAG,CAAC,QAAQ,CAAC,sBAAsB,EAAEZ,gBAAgB,CAAC,CAAC;QAEnE,MAAMa,QAAQpB,sBAAsB;YAAEY;QAAQ;QAC9C,IAAI,CAACP,OAAOgB,WAAW,EAAE;YACvBhB,OAAOgB,WAAW,GAAG;gBAACD;aAAM;QAC9B,OAAO,IAAIf,OAAOgB,WAAW,CAACC,IAAI,CAAC,CAACC,MAAQA,IAAIC,IAAI,KAAK,UAAU;YACjE,MAAM,IAAIC,MAAM;QAClB,OAAO;YACLpB,OAAOgB,WAAW,CAACK,IAAI,CAACN;QAC1B;QAEA;;;KAGC,GACD,IAAIhB,cAAcuB,QAAQ,EAAE;YAC1B,OAAOtB;QACT;QAEA,IAAI,CAACA,OAAOuB,SAAS,EAAE;YACrBvB,OAAOuB,SAAS,GAAG,EAAE;QACvB;QAEA,IAAI,CAACvB,OAAOwB,KAAK,EAAE;YACjBxB,OAAOwB,KAAK,GAAG,CAAC;QAClB;QAEA,IAAI,CAACxB,OAAOwB,KAAK,CAACC,IAAI,EAAE;YACtBzB,OAAOwB,KAAK,CAACC,IAAI,GAAGV,MAAMI,IAAI;QAChC,OAAO,IAAInB,OAAOwB,KAAK,CAACC,IAAI,KAAKV,MAAMI,IAAI,EAAE;YAC3C,MAAM,IAAIC,MACR;QAEJ;QAEA,IAAI,CAACpB,OAAOwB,KAAK,CAACE,UAAU,EAAE;YAC5B1B,OAAOwB,KAAK,CAACE,UAAU,GAAG,CAAC;QAC7B;QAEA,IAAI,CAAC1B,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,EAAE;YAClC3B,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,GAAG,CAAC;QACnC;QAEA,IAAI,CAAC3B,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,CAACC,KAAK,EAAE;YACxC5B,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,CAACC,KAAK,GAAG;gBACpCC,WAAW;oBACTC,MAAM;oBACNC,aAAa;wBACX1B;wBACAQ;wBACAF;oBACF;gBACF;gBACAqB,OAAO;gBACPF,MAAM;YACR;QACF,OAAO;YACL,MAAM,IAAIV,MACR;QAEJ;QAEA,IAAI,CAACpB,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,CAACM,WAAW,EAAE;YAC9CjC,OAAOwB,KAAK,CAACE,UAAU,CAACC,KAAK,CAACM,WAAW,GAAG;gBAC1CJ,WAAW;gBACXG,OAAO;gBACPF,MAAM;YACR;QACF,OAAO;YACL,MAAM,IAAIV,MACR;QAEJ;QAEA,IAAI,CAACpB,OAAOwB,KAAK,CAACU,MAAM,EAAE;YACxBlC,OAAOwB,KAAK,CAACU,MAAM,GAAG,CAAC;QACzB;QAEA,IAAI,CAAClC,OAAOwB,KAAK,CAACU,MAAM,CAACN,KAAK,EAAE;YAC9B5B,OAAOwB,KAAK,CAACU,MAAM,CAACN,KAAK,GAAG;QAC9B,OAAO;YACL,MAAM,IAAIR,MACR;QAEJ;QAEA,MAAMe,iBAAiBnC,OAAOoC,MAAM;QAEpCpC,OAAOoC,MAAM,GAAG,OAAOC;YACrB,gFAAgF;YAChF,IAAIF,gBAAgB;gBAClB,MAAMA,eAAeE;YACvB;YAEA,0FAA0F;YAC1F,MAAMC,YAAYC,KAAKC,GAAG;YAC1B,MAAMjC,QAAQkC,GAAG,CAAC5C,mBAAmB,WAAW6C,OAAOJ;YACvD,yDAAyD;YACzDhC,SAASqC,qBAAqB,CAAC,WAAWL;YAC1C,MAAM9B,OAAOM,GAAG,CAAC,SAAS;QAE1B,0FAA0F;QAC1F,6FAA6F;QAC/F;QAEA,OAAOd;IACT,EAAC"}