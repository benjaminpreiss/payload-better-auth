{"version":3,"sources":["../../src/payload/plugin.ts"],"sourcesContent":["import type { ClientOptions } from 'better-auth'\nimport type { Config } from 'payload'\n\nimport { createUsersCollection } from '../collections/Users/index'\nimport { triggerFullReconcile } from '../utils/payload-reconcile'\n\nexport type BetterAuthClientOptions = {\n  /**\n   * The external base URL for better-auth, used for client-side requests (from the browser).\n   * This should be the publicly accessible URL.\n   * @example 'https://auth.example.com'\n   */\n  externalBaseURL: string\n  /**\n   * The internal base URL for better-auth, used for server-side requests.\n   * This is used when the server needs to reach better-auth internally (e.g., within a container network).\n   * @example 'http://auth-service:3000'\n   */\n  internalBaseURL: string\n} & Omit<ClientOptions, 'baseURL'>\n\nexport type BetterAuthPayloadPluginOptions = {\n  betterAuthClientOptions: BetterAuthClientOptions\n  /**\n   * Enable debug logging for troubleshooting connection issues.\n   * When enabled, detailed error information will be logged during auth method fetching.\n   */\n  debug?: boolean\n  disabled?: boolean\n  reconcileToken?: string\n}\n\nexport const betterAuthPayloadPlugin =\n  (pluginOptions: BetterAuthPayloadPluginOptions) =>\n  (config: Config): Config => {\n    const { externalBaseURL, internalBaseURL, ...restClientOptions } =\n      pluginOptions.betterAuthClientOptions\n    const debug = pluginOptions.debug ?? false\n\n    // Build internal and external auth client options\n    const internalAuthClientOptions = { ...restClientOptions, baseURL: internalBaseURL }\n    const externalAuthClientOptions = { ...restClientOptions, baseURL: externalBaseURL }\n\n    // Log plugin configuration at startup (excluding sensitive data)\n    if (debug) {\n      console.log('[payload-better-auth] Plugin initializing with configuration:')\n      console.log('[payload-better-auth]   - internalBaseURL:', internalBaseURL)\n      console.log('[payload-better-auth]   - externalBaseURL:', externalBaseURL)\n      console.log('[payload-better-auth]   - disabled:', pluginOptions.disabled ?? false)\n      console.log('[payload-better-auth]   - debug:', debug)\n      console.log(\n        '[payload-better-auth]   - reconcileToken:',\n        pluginOptions.reconcileToken ? '[REDACTED]' : 'not set',\n      )\n      console.log(\n        '[payload-better-auth]   - fetchOptions.headers:',\n        restClientOptions.fetchOptions?.headers ? '[configured]' : 'not set',\n      )\n    }\n\n    const Users = createUsersCollection({\n      authClientOptions: internalAuthClientOptions,\n    })\n    if (!config.collections) {\n      config.collections = [Users]\n    } else if (config.collections.find((col) => col.slug === 'users')) {\n      throw new Error('Payload-better-auth plugin: Users collection already present')\n    } else {\n      config.collections.push(Users)\n    }\n\n    /**\n     * If the plugin is disabled, we still want to keep added collections/fields so the database schema is consistent which is important for migrations.\n     * If your plugin heavily modifies the database schema, you may want to remove this property.\n     */\n    if (pluginOptions.disabled) {\n      return config\n    }\n\n    if (!config.endpoints) {\n      config.endpoints = []\n    }\n\n    if (!config.admin) {\n      config.admin = {}\n    }\n\n    if (!config.admin.user) {\n      config.admin.user = Users.slug\n    } else if (config.admin.user !== Users.slug) {\n      throw new Error(\n        'Payload-better-auth plugin: admin.user property already set with conflicting value.',\n      )\n    }\n\n    if (!config.admin.components) {\n      config.admin.components = {}\n    }\n\n    if (!config.admin.components.views) {\n      config.admin.components.views = {}\n    }\n\n    if (!config.admin.components.views.login) {\n      config.admin.components.views.login = {\n        Component: {\n          path: 'payload-better-auth/rsc#BetterAuthLoginServer',\n          serverProps: {\n            debug,\n            externalAuthClientOptions,\n            internalAuthClientOptions,\n          },\n        },\n        exact: true,\n        path: '/auth',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.login property in config already set.',\n      )\n    }\n\n    if (!config.admin.components.views.verifyEmail) {\n      config.admin.components.views.verifyEmail = {\n        Component: 'payload-better-auth/client#VerifyEmailInfoViewClient', // RSC or 'use client' component\n        exact: true,\n        path: '/auth/verify-email',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.verifyEmail property in config already set.',\n      )\n    }\n\n    if (!config.admin.routes) {\n      config.admin.routes = {}\n    }\n\n    if (!config.admin.routes.login) {\n      config.admin.routes.login = '/auth'\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.routes.login property in config already set.',\n      )\n    }\n\n    const incomingOnInit = config.onInit\n\n    config.onInit = async (payload) => {\n      // Ensure we are executing any existing onInit functions before running our own.\n      if (incomingOnInit) {\n        await incomingOnInit(payload)\n      }\n      await triggerFullReconcile({\n        additionalHeaders: restClientOptions.fetchOptions?.headers,\n        betterAuthUrl: internalBaseURL,\n        payload,\n        reconcileToken: pluginOptions.reconcileToken,\n      })\n    }\n\n    return config\n  }\n"],"names":["createUsersCollection","triggerFullReconcile","betterAuthPayloadPlugin","pluginOptions","config","externalBaseURL","internalBaseURL","restClientOptions","betterAuthClientOptions","debug","internalAuthClientOptions","baseURL","externalAuthClientOptions","console","log","disabled","reconcileToken","fetchOptions","headers","Users","authClientOptions","collections","find","col","slug","Error","push","endpoints","admin","user","components","views","login","Component","path","serverProps","exact","verifyEmail","routes","incomingOnInit","onInit","payload","additionalHeaders","betterAuthUrl"],"mappings":"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"}