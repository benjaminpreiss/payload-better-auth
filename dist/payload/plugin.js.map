{"version":3,"sources":["../../src/payload/plugin.ts"],"sourcesContent":["import type { ClientOptions } from 'better-auth'\nimport type { Access, CollectionConfig, Config } from 'payload'\n\nimport type { EventBus } from '../eventBus/types'\nimport type { SecondaryStorage } from '../storage/types'\n\nimport { createEmailPasswordCollection } from '../collections/BetterAuth/emailPassword'\nimport { createMagicLinkCollection } from '../collections/BetterAuth/magicLink'\nimport { extendUsersCollection } from '../collections/Users/index'\nimport { createDeduplicatedLogger } from '../shared/deduplicatedLogger'\nimport { TIMESTAMP_PREFIX } from '../storage/keys'\n\nexport type BetterAuthClientOptions = {\n  /**\n   * The external base URL for better-auth, used for client-side requests (from the browser).\n   * This should be the publicly accessible URL.\n   * @example 'https://auth.example.com'\n   */\n  externalBaseURL: string\n  /**\n   * The internal base URL for better-auth, used for server-side requests.\n   * This is used when the server needs to reach better-auth internally (e.g., within a container network).\n   * @example 'http://auth-service:3000'\n   */\n  internalBaseURL: string\n} & Omit<ClientOptions, 'baseURL'>\n\nexport type BetterAuthPayloadPluginOptions = {\n  /**\n   * Custom access rules for Better Auth collections (email_password, magic_link).\n   * These override the default debug-mode access (which allows read for authenticated users).\n   *\n   * @example\n   * baCollectionsAccess: {\n   *   read: ({ req }) => req.user?.role === 'admin',\n   *   delete: ({ req }) => req.user?.role === 'admin',\n   * }\n   */\n  baCollectionsAccess?: {\n    delete?: Access\n    read?: Access\n  }\n  betterAuthClientOptions: BetterAuthClientOptions\n  /**\n   * Prefix for Better Auth collections (default: '__better_auth').\n   * The collections will be named: {prefix}_email_password, {prefix}_magic_link\n   */\n  collectionPrefix?: string\n  /**\n   * Enable debug logging and make BA collections visible in admin.\n   * When enabled:\n   * - Detailed error information will be logged\n   * - BA collections are visible under \"Better Auth (DEBUG)\" group\n   * - Authenticated users can read BA collections (unless baCollectionsAccess overrides)\n   */\n  debug?: boolean\n  disabled?: boolean\n  /**\n   * EventBus for timestamp-based coordination between plugins.\n   * Both plugins MUST share the same eventBus instance.\n   *\n   * Available implementations:\n   * - `createSqlitePollingEventBus()` - Uses SQLite for cross-process coordination\n   *\n   * @example\n   * // Create shared eventBus (e.g., in a separate file)\n   * import { createSqlitePollingEventBus } from 'payload-better-auth'\n   * import { DatabaseSync } from 'node:sqlite'\n   * const db = new DatabaseSync('.event-bus.db')\n   * export const eventBus = createSqlitePollingEventBus({ db })\n   */\n  eventBus: EventBus\n  /**\n   * Secondary storage for state coordination between Better Auth and Payload.\n   * Both plugins MUST share the same storage instance.\n   *\n   * Available storage adapters:\n   * - `createSqliteStorage()` - Uses Node.js 22+ native SQLite (no external dependencies)\n   * - `createRedisStorage(redis)` - Redis-backed, for distributed/multi-server production\n   *\n   * @example\n   * // Development (Node.js 22+)\n   * import { createSqliteStorage } from 'payload-better-auth'\n   * import { DatabaseSync } from 'node:sqlite'\n   * const db = new DatabaseSync('.sync-state.db')\n   * const storage = createSqliteStorage({ db })\n   *\n   * @example\n   * // Production (distributed)\n   * import { createRedisStorage } from 'payload-better-auth'\n   * import Redis from 'ioredis'\n   * const storage = createRedisStorage({ redis: new Redis() })\n   */\n  storage: SecondaryStorage\n}\n\nexport const betterAuthPayloadPlugin =\n  (pluginOptions: BetterAuthPayloadPluginOptions) =>\n  (config: Config): Config => {\n    const { externalBaseURL, internalBaseURL, ...restClientOptions } =\n      pluginOptions.betterAuthClientOptions\n    const debug = pluginOptions.debug ?? false\n    const collectionPrefix = pluginOptions.collectionPrefix ?? '__better_auth'\n    const { baCollectionsAccess, eventBus, storage } = pluginOptions\n\n    // Create deduplicated logger\n    const logger = createDeduplicatedLogger({\n      enabled: debug,\n      prefix: '[payload]',\n      storage,\n    })\n\n    // Build internal and external auth client options\n    const internalAuthClientOptions = { ...restClientOptions, baseURL: internalBaseURL }\n    const externalAuthClientOptions = { ...restClientOptions, baseURL: externalBaseURL }\n\n    // Log plugin configuration at startup (deduplicated)\n    void logger.log('init', `Initialized (baseURL: ${internalBaseURL})`)\n\n    // Determine BA collection access:\n    // 1. If baCollectionsAccess is provided, use it (overrides debug defaults)\n    // 2. If debug is enabled, allow authenticated users to read\n    // 3. Otherwise, no custom access (only BA sync agent)\n    const effectiveBaAccess: { delete?: Access; read?: Access } | undefined = baCollectionsAccess\n      ? baCollectionsAccess\n      : debug\n        ? { read: ({ req }) => Boolean(req.user) }\n        : undefined\n\n    // Initialize collections array if not present\n    if (!config.collections) {\n      config.collections = []\n    }\n\n    // Create BA collections\n    const emailPasswordCollection = createEmailPasswordCollection({\n      access: effectiveBaAccess,\n      isVisible: debug,\n      prefix: collectionPrefix,\n      storage,\n    })\n    const magicLinkCollection = createMagicLinkCollection({\n      access: effectiveBaAccess,\n      isVisible: debug,\n      prefix: collectionPrefix,\n      storage,\n    })\n\n    // Find and extend existing users collection, or create minimal one\n    const existingUsersIndex = config.collections.findIndex((col) => col.slug === 'users')\n    const existingUsersCollection: CollectionConfig | undefined =\n      existingUsersIndex >= 0 ? config.collections[existingUsersIndex] : undefined\n\n    const extendedUsersCollection = extendUsersCollection(existingUsersCollection, {\n      collectionPrefix,\n      storage,\n    })\n\n    // Replace or add the users collection\n    if (existingUsersIndex >= 0) {\n      config.collections[existingUsersIndex] = extendedUsersCollection\n    } else {\n      config.collections.push(extendedUsersCollection)\n    }\n\n    // Add BA collections\n    config.collections.push(emailPasswordCollection)\n    config.collections.push(magicLinkCollection)\n\n    /**\n     * If the plugin is disabled, we still want to keep added collections/fields so the database schema is consistent which is important for migrations.\n     * If your plugin heavily modifies the database schema, you may want to remove this property.\n     */\n    if (pluginOptions.disabled) {\n      return config\n    }\n\n    if (!config.endpoints) {\n      config.endpoints = []\n    }\n\n    if (!config.admin) {\n      config.admin = {}\n    }\n\n    if (!config.admin.user) {\n      config.admin.user = extendedUsersCollection.slug\n    } else if (config.admin.user !== extendedUsersCollection.slug) {\n      throw new Error(\n        'Payload-better-auth plugin: admin.user property already set with conflicting value.',\n      )\n    }\n\n    if (!config.admin.components) {\n      config.admin.components = {}\n    }\n\n    if (!config.admin.components.views) {\n      config.admin.components.views = {}\n    }\n\n    if (!config.admin.components.views.login) {\n      config.admin.components.views.login = {\n        Component: {\n          path: 'payload-better-auth/rsc#BetterAuthLoginServer',\n          serverProps: {\n            debug,\n            externalAuthClientOptions,\n            internalAuthClientOptions,\n          },\n        },\n        exact: true,\n        path: '/auth',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.login property in config already set.',\n      )\n    }\n\n    if (!config.admin.components.views.verifyEmail) {\n      config.admin.components.views.verifyEmail = {\n        Component: 'payload-better-auth/client#VerifyEmailInfoViewClient', // RSC or 'use client' component\n        exact: true,\n        path: '/auth/verify-email',\n      }\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.components.views.verifyEmail property in config already set.',\n      )\n    }\n\n    if (!config.admin.routes) {\n      config.admin.routes = {}\n    }\n\n    if (!config.admin.routes.login) {\n      config.admin.routes.login = '/auth'\n    } else {\n      throw new Error(\n        'Payload-better-auth plugin: admin.routes.login property in config already set.',\n      )\n    }\n\n    const incomingOnInit = config.onInit\n\n    config.onInit = async (payload) => {\n      // Ensure we are executing any existing onInit functions before running our own.\n      if (incomingOnInit) {\n        await incomingOnInit(payload)\n      }\n\n      // Set Payload timestamp in storage - Better Auth will see this and trigger reconciliation\n      const timestamp = Date.now()\n      await storage.set(TIMESTAMP_PREFIX + 'payload', String(timestamp))\n      // Also notify via event bus for same-process subscribers\n      eventBus.notifyTimestampChange('payload', timestamp)\n      await logger.log('ready', 'Ready, triggering Better Auth initialization')\n\n      // Trigger Better Auth initialization by calling the warmup endpoint\n      // Better Auth plugins are lazy-initialized on first request\n      try {\n        const warmupUrl = `${internalBaseURL}/api/auth/warmup`\n        const response = await fetch(warmupUrl, {\n          headers: { 'User-Agent': 'Payload-Better-Auth-Warmup' },\n          method: 'GET',\n        })\n        if (response.ok) {\n          const info = (await response.json()) as {\n            authMethods: string[]\n            initialized: boolean\n            timestamp: string\n          }\n          await logger.log('warmup', 'Better Auth initialized', {\n            authMethods: info.authMethods,\n          })\n        } else {\n          await logger.log('warmup-error', 'Better Auth warmup returned error', {\n            status: response.status,\n          })\n        }\n      } catch (error) {\n        // Log but don't fail - Better Auth will initialize on first real request\n        await logger.log(\n          'warmup-error',\n          'Failed to warm up Better Auth (will init on first request)',\n          {\n            error: error instanceof Error ? error.message : String(error),\n          },\n        )\n      }\n\n      // Note: User sync is now handled entirely by the reconcile queue on the Better Auth side.\n      // The queue enqueues ensure/delete tasks when users change, and processes them with retries.\n    }\n\n    return config\n  }\n"],"names":["createEmailPasswordCollection","createMagicLinkCollection","extendUsersCollection","createDeduplicatedLogger","TIMESTAMP_PREFIX","betterAuthPayloadPlugin","pluginOptions","config","externalBaseURL","internalBaseURL","restClientOptions","betterAuthClientOptions","debug","collectionPrefix","baCollectionsAccess","eventBus","storage","logger","enabled","prefix","internalAuthClientOptions","baseURL","externalAuthClientOptions","log","effectiveBaAccess","read","req","Boolean","user","undefined","collections","emailPasswordCollection","access","isVisible","magicLinkCollection","existingUsersIndex","findIndex","col","slug","existingUsersCollection","extendedUsersCollection","push","disabled","endpoints","admin","Error","components","views","login","Component","path","serverProps","exact","verifyEmail","routes","incomingOnInit","onInit","payload","timestamp","Date","now","set","String","notifyTimestampChange","warmupUrl","response","fetch","headers","method","ok","info","json","authMethods","status","error","message"],"mappings":"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"}