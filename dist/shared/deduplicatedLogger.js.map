{"version":3,"sources":["../../src/shared/deduplicatedLogger.ts"],"sourcesContent":["import type { SecondaryStorage } from '../storage/types'\n\n/**\n * A logger that deduplicates messages by storing them in KV storage.\n * Only prints if the message is different from the last logged message for that key.\n */\nexport interface DeduplicatedLogger {\n  /**\n   * Always log a message (bypasses deduplication).\n   * Use for important events that should always be visible.\n   */\n  always(message: string, extra?: unknown): void\n\n  /**\n   * Clear all stored log state (useful for testing or reset).\n   */\n  clear(key: string): Promise<void>\n\n  /**\n   * Log a message if it's different from the last logged message for this key.\n   * @param key - Unique key to deduplicate against (e.g., 'init', 'status')\n   * @param message - The message to log\n   * @param extra - Optional extra data to include (will be JSON stringified)\n   */\n  log(key: string, message: string, extra?: unknown): Promise<void>\n}\n\nexport interface CreateLoggerOptions {\n  /**\n   * Enable logging. If false, all log calls are no-ops.\n   */\n  enabled: boolean\n\n  /**\n   * Prefix for log messages.\n   * @default '[payload-better-auth]'\n   */\n  prefix?: string\n\n  /**\n   * Storage instance for deduplication.\n   */\n  storage: SecondaryStorage\n}\n\nimport { LOG_KEY_PREFIX } from '../storage/keys'\n\n/**\n * Create a deduplicated logger instance.\n *\n * @example\n * const logger = createDeduplicatedLogger({\n *   storage,\n *   enabled: true,\n *   prefix: '[my-plugin]'\n * })\n *\n * // Only logs if message changed\n * await logger.log('status', 'Ready')\n * await logger.log('status', 'Ready') // No output (duplicate)\n * await logger.log('status', 'Syncing...') // Logs (different message)\n *\n * // Always logs\n * logger.always('Important event happened!')\n */\nexport function createDeduplicatedLogger(options: CreateLoggerOptions): DeduplicatedLogger {\n  const { enabled, prefix = '[payload-better-auth]', storage } = options\n\n  // No-op logger when disabled\n  if (!enabled) {\n    return {\n      always: () => {},\n      clear: () => Promise.resolve(),\n      log: () => Promise.resolve(),\n    }\n  }\n\n  return {\n    always(message: string, extra?: unknown): void {\n      if (extra !== undefined) {\n        // eslint-disable-next-line no-console\n        console.log(\n          `${prefix} ${message}`,\n          typeof extra === 'object' ? JSON.stringify(extra, null, 2) : extra,\n        )\n      } else {\n        // eslint-disable-next-line no-console\n        console.log(`${prefix} ${message}`)\n      }\n    },\n\n    async clear(key: string): Promise<void> {\n      await storage.delete(LOG_KEY_PREFIX + key)\n    },\n\n    async log(key: string, message: string, extra?: unknown): Promise<void> {\n      const storageKey = LOG_KEY_PREFIX + key\n\n      // Create a hash of the message + extra for comparison\n      const messageHash = extra !== undefined ? `${message}::${JSON.stringify(extra)}` : message\n\n      // Check if this is the same as the last logged message\n      const lastHash = await storage.get(storageKey)\n      if (lastHash === messageHash) {\n        // Same message, skip logging\n        return\n      }\n\n      // Store the new message hash\n      await storage.set(storageKey, messageHash)\n\n      // Log the message\n      if (extra !== undefined) {\n        // eslint-disable-next-line no-console\n        console.log(\n          `${prefix} ${message}`,\n          typeof extra === 'object' ? JSON.stringify(extra, null, 2) : extra,\n        )\n      } else {\n        // eslint-disable-next-line no-console\n        console.log(`${prefix} ${message}`)\n      }\n    },\n  }\n}\n"],"names":["LOG_KEY_PREFIX","createDeduplicatedLogger","options","enabled","prefix","storage","always","clear","Promise","resolve","log","message","extra","undefined","console","JSON","stringify","key","delete","storageKey","messageHash","lastHash","get","set"],"mappings":"AA6CA,SAASA,cAAc,QAAQ,kBAAiB;AAEhD;;;;;;;;;;;;;;;;;CAiBC,GACD,OAAO,SAASC,yBAAyBC,OAA4B;IACnE,MAAM,EAAEC,OAAO,EAAEC,SAAS,uBAAuB,EAAEC,OAAO,EAAE,GAAGH;IAE/D,6BAA6B;IAC7B,IAAI,CAACC,SAAS;QACZ,OAAO;YACLG,QAAQ,KAAO;YACfC,OAAO,IAAMC,QAAQC,OAAO;YAC5BC,KAAK,IAAMF,QAAQC,OAAO;QAC5B;IACF;IAEA,OAAO;QACLH,QAAOK,OAAe,EAAEC,KAAe;YACrC,IAAIA,UAAUC,WAAW;gBACvB,sCAAsC;gBACtCC,QAAQJ,GAAG,CACT,GAAGN,OAAO,CAAC,EAAEO,SAAS,EACtB,OAAOC,UAAU,WAAWG,KAAKC,SAAS,CAACJ,OAAO,MAAM,KAAKA;YAEjE,OAAO;gBACL,sCAAsC;gBACtCE,QAAQJ,GAAG,CAAC,GAAGN,OAAO,CAAC,EAAEO,SAAS;YACpC;QACF;QAEA,MAAMJ,OAAMU,GAAW;YACrB,MAAMZ,QAAQa,MAAM,CAAClB,iBAAiBiB;QACxC;QAEA,MAAMP,KAAIO,GAAW,EAAEN,OAAe,EAAEC,KAAe;YACrD,MAAMO,aAAanB,iBAAiBiB;YAEpC,sDAAsD;YACtD,MAAMG,cAAcR,UAAUC,YAAY,GAAGF,QAAQ,EAAE,EAAEI,KAAKC,SAAS,CAACJ,QAAQ,GAAGD;YAEnF,uDAAuD;YACvD,MAAMU,WAAW,MAAMhB,QAAQiB,GAAG,CAACH;YACnC,IAAIE,aAAaD,aAAa;gBAC5B,6BAA6B;gBAC7B;YACF;YAEA,6BAA6B;YAC7B,MAAMf,QAAQkB,GAAG,CAACJ,YAAYC;YAE9B,kBAAkB;YAClB,IAAIR,UAAUC,WAAW;gBACvB,sCAAsC;gBACtCC,QAAQJ,GAAG,CACT,GAAGN,OAAO,CAAC,EAAEO,SAAS,EACtB,OAAOC,UAAU,WAAWG,KAAKC,SAAS,CAACJ,OAAO,MAAM,KAAKA;YAEjE,OAAO;gBACL,sCAAsC;gBACtCE,QAAQJ,GAAG,CAAC,GAAGN,OAAO,CAAC,EAAEO,SAAS;YACpC;QACF;IACF;AACF"}