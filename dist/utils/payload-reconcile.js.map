{"version":3,"sources":["../../src/utils/payload-reconcile.ts"],"sourcesContent":["import type { Payload } from 'payload'\n\n/**\n * Triggers a full reconcile operation via the Better Auth reconcile API\n * This is typically called during Payload initialization to ensure data consistency\n */\nexport async function triggerFullReconcile({\n  additionalHeaders,\n  betterAuthUrl,\n  payload,\n  reconcileToken,\n}: {\n  additionalHeaders?: HeadersInit\n  betterAuthUrl: string\n  payload: Payload\n  reconcileToken?: string\n}): Promise<void> {\n  try {\n    if (!reconcileToken) {\n      payload.logger.warn('reconcile token not set, skipping onInit reconcile trigger')\n      return\n    }\n\n    const reconcileUrl = `${betterAuthUrl}/api/auth/reconcile/run`\n\n    payload.logger.info('Triggering full reconcile from Payload onInit...')\n\n    const headers = new Headers(additionalHeaders)\n    headers.append('Content-Type', 'application/json')\n    headers.append('x-reconcile-token', reconcileToken)\n\n    const response = await fetch(reconcileUrl, {\n      body: JSON.stringify({}),\n      headers,\n      method: 'POST',\n    })\n\n    if (!response.ok) {\n      throw new Error(`Reconcile request failed: ${response.status} ${response.statusText}`)\n    }\n\n    const result = await response.json()\n    payload.logger.info(\n      `Full reconcile triggered successfully from Payload onInit: ${JSON.stringify(result)}`,\n    )\n  } catch (error) {\n    payload.logger.error(`Failed to trigger full reconcile from Payload onInit: ${error}`)\n    // Don't throw - we don't want to prevent Payload from starting if reconcile fails\n  }\n}\n"],"names":["triggerFullReconcile","additionalHeaders","betterAuthUrl","payload","reconcileToken","logger","warn","reconcileUrl","info","headers","Headers","append","response","fetch","body","JSON","stringify","method","ok","Error","status","statusText","result","json","error"],"mappings":"AAEA;;;CAGC,GACD,OAAO,eAAeA,qBAAqB,EACzCC,iBAAiB,EACjBC,aAAa,EACbC,OAAO,EACPC,cAAc,EAMf;IACC,IAAI;QACF,IAAI,CAACA,gBAAgB;YACnBD,QAAQE,MAAM,CAACC,IAAI,CAAC;YACpB;QACF;QAEA,MAAMC,eAAe,GAAGL,cAAc,uBAAuB,CAAC;QAE9DC,QAAQE,MAAM,CAACG,IAAI,CAAC;QAEpB,MAAMC,UAAU,IAAIC,QAAQT;QAC5BQ,QAAQE,MAAM,CAAC,gBAAgB;QAC/BF,QAAQE,MAAM,CAAC,qBAAqBP;QAEpC,MAAMQ,WAAW,MAAMC,MAAMN,cAAc;YACzCO,MAAMC,KAAKC,SAAS,CAAC,CAAC;YACtBP;YACAQ,QAAQ;QACV;QAEA,IAAI,CAACL,SAASM,EAAE,EAAE;YAChB,MAAM,IAAIC,MAAM,CAAC,0BAA0B,EAAEP,SAASQ,MAAM,CAAC,CAAC,EAAER,SAASS,UAAU,EAAE;QACvF;QAEA,MAAMC,SAAS,MAAMV,SAASW,IAAI;QAClCpB,QAAQE,MAAM,CAACG,IAAI,CACjB,CAAC,2DAA2D,EAAEO,KAAKC,SAAS,CAACM,SAAS;IAE1F,EAAE,OAAOE,OAAO;QACdrB,QAAQE,MAAM,CAACmB,KAAK,CAAC,CAAC,sDAAsD,EAAEA,OAAO;IACrF,kFAAkF;IACpF;AACF"}